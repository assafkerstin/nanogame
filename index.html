<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano - Resource Management Game</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .view { display: none; }
        .active-view { display: block; }
        .navbar { background-color: #343a40; }
        .navbar-brand, .nav-link { color: #fff !important; }
        .card { margin-bottom: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,.1); }
        .card-header { background-color: #6c757d; color: white; font-weight: bold; }
        .btn-primary { background-color: #007bff; border-color: #007bff; }
        .resource-icon { width: 24px; height: 24px; margin-right: 8px; vertical-align: middle; }
        .stat-card { text-align: center; }
        .stat-card .value { font-size: 1.5rem; font-weight: bold; }
        .stat-card .label { font-size: 0.9rem; color: #6c757d; }
        .countdown-timer, .protection-timer { font-weight: bold; color: #dc3545; }
        #auth-container, #game-container { max-width: 960px; margin: auto; padding: 20px; }
        .order-book-table { font-size: 0.9em; }
        .order-book-table td, .order-book-table th { padding: 0.4rem; }
    </style>
</head>
<body>

    <div id="auth-container">
        <div id="login-form">
            <div class="card">
                <div class="card-header">Login</div>
                <div class="card-body">
                    <input type="text" id="login-username" class="form-control mb-2" placeholder="Username">
                    <input type="password" id="login-password" class="form-control mb-2" placeholder="Password">
                    <button id="login-btn" class="btn btn-primary w-100">Login</button>
                    <p class="text-center mt-3">No account? <a href="#" id="show-register-link">Register here</a></p>
                </div>
            </div>
        </div>

        <div id="register-form" style="display: none;">
             <div class="card">
                <div class="card-header">Register</div>
                <div class="card-body">
                    <input type="text" id="register-username" class="form-control mb-2" placeholder="Username">
                    <input type="email" id="register-email" class="form-control mb-2" placeholder="Email">
                    <input type="password" id="register-password" class="form-control mb-2" placeholder="Password">
                    <button id="register-btn" class="btn btn-success w-100">Register</button>
                    <p class="text-center mt-3">Already have an account? <a href="#" id="show-login-link">Login here</a></p>
                </div>
            </div>
        </div>
        <div id="error-message" class="alert alert-danger mt-3" style="display: none;"></div>
    </div>

    <div id="game-container" style="display: none;">
        <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Nano Game</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link" href="#" data-view="home-view"><i class="bi bi-house-door"></i> Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-view="workers-view"><i class="bi bi-person-walking"></i> Workers</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-view="buildings-view"><i class="bi bi-building"></i> Buildings</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-view="army-view"><i class="bi bi-shield-shaded"></i> Army</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-view="conquer-view"><i class="bi bi-flag-fill"></i> Conquer</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-view="jobs-view"><i class="bi bi-briefcase"></i> Jobs</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-view="market-view"><i class="bi bi-graph-up"></i> Market</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-view="history-view"><i class="bi bi-clock-history"></i> History</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-view="tax-collection-view"><i class="bi bi-bank"></i> Tax Collection</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-view="distribution-view"><i class="bi bi-pie-chart"></i> Distribution</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-view="distribution-history-view"><i class="bi bi-card-list"></i> Dist. History</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-view="leaderboard-view"><i class="bi bi-trophy"></i> Leaderboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-view="harvesting-activity-view"><i class="bi bi-graph-down"></i> Harvesting</a></li>
                    </ul>
                    <span class="navbar-text me-3" id="username-display"></span>
                    <button class="btn btn-outline-light" id="logout-btn">Logout</button>
                </div>
            </div>
        </nav>

        <div style="height: 70px;"></div> <div id="home-view" class="view">
            <h3>Dashboard</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            Resources & Balances
                            <i class="bi bi-question-circle-fill"
                               data-bs-toggle="popover"
                               data-bs-trigger="hover"
                               data-bs-title="Balance Descriptions"
                               data-bs-content="Nano Coin: In-game currency earned from jobs and sales. Game Credits: Premium currency. Resources: Used for building and recruiting. Employees: Your workforce for tasks."></i>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-cash-coin text-success"></i> Nano Coin</span> <strong id="earned-nano-balance">0.00000000</strong></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-gem text-primary"></i> Game Credits</span> <strong id="unearned-nano-balance">0.00000000</strong></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-tree text-success"></i> Wood</span> <strong id="wood-balance">0.00000000</strong></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-minecart-loaded text-secondary"></i> Iron</span> <strong id="iron-balance">0.00000000</strong></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-bricks text-muted"></i> Stone</span> <strong id="stone-balance">0.00000000</strong></li>
                                 <li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-people-fill"></i> Employees</span> <strong id="employees-count">0</strong></li>
                            </ul>
                            <p id="next-worker-message" class="text-center small text-muted mt-2"></p>
                        </div>
                    </div>
                     <div class="card">
                        <div class="card-header">Last 24H Harvest Activity</div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush" id="last-24h-activity-summary">
                            </ul>
                        </div>
                    </div>
                </div>
                 <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Military Status</div>
                         <div class="card-body">
                            <div class="row">
                                <div class="col-4 stat-card">
                                    <div class="value" id="soldiers-count">0</div>
                                    <div class="label">Soldiers</div>
                                </div>
                                <div class="col-4 stat-card">
                                    <div class="value" id="military-swords">0</div>
                                    <div class="label">Swords</div>
                                </div>
                                <div class="col-4 stat-card">
                                    <div class="value" id="military-power">0.00000000</div>
                                    <div class="label">Military Power</div>
                                </div>
                            </div>
                            <hr>
                            <div id="military-power-breakdown" class="text-center small text-muted"></div>
                        </div>
                    </div>
                     <div class="card">
                        <div class="card-header">Building Levels</div>
                        <div class="card-body" id="dashboard-buildings-summary">
                        </div>
                    </div>
                </div>
            </div>
             <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">Productivity</div>
                        <div class="card-body" id="dashboard-productivity-stats">
                        </div>
                    </div>
                </div>
            </div>
             <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">Worker Status</div>
                        <div class="card-body row" id="dashboard-worker-status">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="workers-view" class="view">
            <h3>Workers</h3>
            <div id="worker-list" class="row"></div>
        </div>

        <div id="buildings-view" class="view">
            <h3>Buildings</h3>
            <div id="building-list" class="row"></div>
        </div>

        <div id="army-view" class="view">
            <h3>Army</h3>
            <div class="row">
                <div class="col-md-7">
                    <div class="card">
                        <div class="card-header">Army Overview</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-4 stat-card">
                                    <div class="value" id="army-soldiers">0</div>
                                    <div class="label">Soldiers</div>
                                </div>
                                <div class="col-4 stat-card">
                                    <div class="value" id="army-swords">0</div>
                                    <div class="label">Swords</div>
                                </div>
                                <div class="col-4 stat-card">
                                    <div class="value" id="army-power">0.00000000</div>
                                    <div class="label">Military Power</div>
                                </div>
                            </div>
                            <hr>
                            <div id="army-power-breakdown" class="text-center small text-muted"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="card">
                        <div class="card-header">Recruit Soldier</div>
                        <div class="card-body">
                             <p id="recruit-cost-text">Cost: ...</p>
                             <div id="recruit-cost-summary" class="mb-3">
                                <strong id="recruit-cost-status" class="text-danger"></strong>
                             </div>
                             <button id="recruit-btn" class="btn btn-primary w-100">Recruit 1 Soldier</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="conquer-view" class="view">
            <h3>Conquest</h3>
            <div class="card">
                <div class="card-header">Conquest Power</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-4 stat-card">
                            <div class="value" id="conquer-total-power">0.00000000</div>
                            <div class="label">Total Power</div>
                        </div>
                        <div class="col-4 stat-card">
                            <div class="value text-danger" id="conquer-used-power">0.00000000</div>
                            <div class="label">Used Power</div>
                        </div>
                        <div class="col-4 stat-card">
                            <div class="value text-success" id="conquer-unused-power">0.00000000</div>
                            <div class="label">Unused Power</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Currently Occupied</div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>Army Power</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="occupied-list"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Potential Targets</div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>Army Power</th>
                                <th>Status / Action</th>
                            </tr>
                        </thead>
                        <tbody id="targets-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="jobs-view" class="view">
            <h3>Job Market</h3>
            <div class="card">
                <div class="card-header">Post a New Job</div>
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="job-item" class="form-label">Item to Produce</label>
                            <input type="text" id="job-item" class="form-control" value="Sword" disabled>
                        </div>
                        <div class="col-md-3">
                            <label for="job-quantity" class="form-label">Quantity</label>
                            <input type="number" id="job-quantity" class="form-control" min="1" placeholder="e.g., 100">
                        </div>
                        <div class="col-md-3">
                            <label for="job-salary" class="form-label">Salary per Sword</label>
                            <input type="number" id="job-salary" class="form-control" min="0.00000001" step="0.00000001" placeholder="e.g., 0.1">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" id="post-job-btn" disabled>Post Job Offer</button>
                        </div>
                    </div>
                    <div id="job-cost-summary" class="mt-3" style="display: none;">
                        <small><strong>Total Cost:</strong> <span id="job-resource-cost">0</span> Iron & <span id="job-salary-cost">0</span> Currency. <strong id="job-cost-status" class="text-danger"></strong></small>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Open Job Offers</div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Employer</th>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Total Salary</th>
                                <th>Est. Time</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="job-offers-list">
                        </tobody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="market-view" class="view">
            <h3>Market</h3>
             <div class="card">
                <div class="card-body">
                    <div class="mb-3">
                        <label for="market-item-select" class="form-label">Select Item</label>
                        <select class="form-select" id="market-item-select">
                            <option value="wood">Wood</option>
                            <option value="iron">Iron</option>
                            <option value="stone">Stone</option>
                            <option value="sword">Sword</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">Buy Orders (Bids)</div>
                        <div class="card-body p-0">
                            <table class="table table-striped order-book-table mb-0">
                                <thead><tr><th>Price</th><th>Quantity</th></tr></thead>
                                <tbody id="buy-orders"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-danger text-white">Sell Orders (Asks)</div>
                        <div class="card-body p-0">
                            <table class="table table-striped order-book-table mb-0">
                                <thead><tr><th>Price</th><th>Quantity</th></tr></thead>
                                <tbody id="sell-orders"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

             <div class="card mt-4">
                <div class="card-header">Place a New Order</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                             <select id="order-type" class="form-select">
                                <option value="buy">Buy</option>
                                <option value="sell">Sell</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="number" id="order-quantity" class="form-control" placeholder="Quantity" min="1">
                        </div>
                        <div class="col-md-3">
                             <input type="number" id="order-price" class="form-control" placeholder="Price per unit" step="0.00000001">
                        </div>
                        <div class="col-md-3">
                            <button id="place-order-btn" class="btn btn-primary w-100">Place Order</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="history-view" class="view">
            <h3>Action History</h3>
            <div class="card">
                <ul class="list-group list-group-flush" id="history-log">
                </ul>
            </div>
        </div>

        <div id="tax-collection-view" class="view">
            <h3>Government Treasury</h3>
             <div class="card">
                <div class="card-header">Government Balances</div>
                <div class="card-body">
                    <div id="gov-balances-display" class="row"></div>
                </div>
            </div>
            <h3>Government Tax Collection History</h3>
            <div class="card">
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>Tax Details</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="tax-history-log">
                        </tobody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="distribution-view" class="view">
            <h3>Distribution Pool</h3>
            <div class="card">
                <div class="card-header">24-Hour Tax Revenue</div>
                <div class="card-body text-center">
                    <h4>Total Tax Collected (Last 24h)</h4>
                    <p class="display-4" id="distribution-total">0.00000000</p>
                    <p class="text-muted">This is the total currency collected by the government which is used for referral payouts and other distributions.</p>
                </div>
            </div>
        </div>

        <div id="distribution-history-view" class="view">
            <h3>Distribution History</h3>
            <div class="card">
                <div class="card-header">Recent Distributions</div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Recipient</th>
                                <th>Distribution</th>
                                <th>Reason</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="distribution-history-log"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="harvesting-activity-view" class="view">
             <h3>Harvesting Activity</h3>
            <div class="card">
                <div class="card-body">
                    <div class="mb-3">
                        <label for="harvesting-timeframe-select" class="form-label">Select Timeframe</label>
                        <select id="harvesting-timeframe-select" class="form-select">
                            <option value="24_hours">Last 24 Hours</option>
                            <option value="all_time">All Time</option>
                        </select>
                    </div>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>Total Harvest Actions</th>
                            </tr>
                        </thead>
                        <tbody id="harvesting-activity-content">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="leaderboard-view" class="view">
            <h3>Leaderboard</h3>
            <div class="card">
                <div class="card-body">
                    <div class="mb-3">
                        <label for="leaderboard-sort-select" class="form-label">Sort By</label>
                        <select id="leaderboard-sort-select" class="form-select">
                            <option value="net_worth">Net Worth</option>
                            <option value="military_power">Military Power</option>
                            <option value="sword">Swords</option>
                            <option value="workers">Workers</option>
                            <optgroup label="Productivity Actions">
                                <option value="prod_today">Today</option>
                                <option value="prod_7_days">Last 7 Days</option>
                                <option value="prod_30_days">Last 30 Days</option>
                                <option value="prod_all_time">All Time</option>
                            </optgroup>
                            <optgroup label="Total Harvested (All Time)">
                                <option value="harvest_total">All Resources</option>
                                <option value="harvest_wood_total">Wood</option>
                                <option value="harvest_iron_total">Iron</option>
                                <option value="harvest_stone_total">Stone</option>
                            </optgroup>
                             <optgroup label="Total Produced (All Time)">
                                <option value="swords_produced_total">Swords</option>
                            </optgroup>
                        </select>
                    </div>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th id="leaderboard-score-header">Net Worth</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-content">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    $(document).ready(function() {
        const API_URL = 'api.php';
        let gameState = {};
        let activeTimers = [];

        function apiCall(data, callback) {
            $.post(API_URL, data, function(response) {
                if (response.auth_error) {
                    showLoginScreen();
                } else {
                    callback(response);
                }
            }, 'json').fail(function(jqXHR) {
                console.error("API Call Failed:", jqXHR.responseText);
                showError("Error communicating with the server. Check console for details.");
            });
        }

        function showError(message) {
            $('#error-message').text(message).show();
        }

        function clearAllTimers() {
            activeTimers.forEach(timerId => clearInterval(timerId));
            activeTimers = [];
        }

        function formatDuration(totalSeconds) {
            if (isNaN(totalSeconds) || totalSeconds < 0) return "00:00:00";
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
        }

        function showView(viewId) {
            clearAllTimers();
            $('.view').removeClass('active-view');
            $('#' + viewId).addClass('active-view');

            switch (viewId) {
                case 'home-view':
                case 'workers-view':
                case 'buildings-view':
                case 'army-view':
                    fetchAndUpdateGameState();
                    break;
                case 'market-view':
                    updateMarketView();
                    break;
                case 'history-view':
                    updateHistoryView();
                    break;
                case 'jobs-view':
                    updateJobsView();
                    break;
                case 'tax-collection-view':
                    updateTaxCollectionView();
                    break;
                case 'distribution-view':
                    updateDistributionView();
                    break;
                case 'distribution-history-view':
                    updateDistributionHistoryView();
                    break;
                case 'leaderboard-view':
                    updateLeaderboardView();
                    break;
                case
